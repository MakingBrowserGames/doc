<!doctype html>

<head>
<style>
html, body { margin: 0px; padding: 0px; }

div, button {
	box-sizing: border-box;
	-ms-box-sizing: border-box;
	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
}

.menu {
	width: 100%;
	height: 100%;
	display: none;
}

</style>
<script src="/sdk/jsio/jsio.js"></script>
</head>

<body style="display:none">
	<div id="mainmenu" class="menu">
		<button id="btnSinglePlayer">Single Player</button>
		<button id="btnMultiplayer">Multiplayer</button>
	</div>
	<div id="lobby" class="menu">
		<button id="btnLogout">back</button>
		<button id="btnLogin">login</button>
		<div id="chat">
			<div id="presence">
				<div class="item_user">martin</div>
			</div>
			<div id="historyWrapper">
				<div id="history"></div>
				<div id="sendChat">
					<input id="textSendMessage" type="text" value="[chat here]" onfocus="clearFocus(this)" class="textInput textDefaultValue">
					<button id="btnSendMessage">send</button>
				</div>
			</div>
		</div>
		<button id="btnSeek">start game</button>
	</div>
	
	<div id="connecting" class="dialog">
		<h1>Connecting to server...</h1>
		<button id="btnCancelConnect">cancel</button>
	</div>
	<div id="seek" class="dialog">
		<h1>Looking for a game...</h1>
		<button id="btnCancelSeek">cancel</button>
	</div>
	
	<div id="login" class="dialog" canClose>
		<div id="rowUsername" class="form_row">
			<span class="label">username:</span><input type="text" value="" id="textUsername" class="textInput">
		</div>
		<div id="rowPassword" class="form_row">
			<span class="label">password:</span><input type="text" value="" id="textPassword" class="textInput">
		</div>
		<div class="form_row">
			<span class="label"></span><button id="loginBtn">login</button>
		</div>
	</div>

<script>
	jsio.path.add('/sdk/lib');
	jsio('from util.browser import $');
	jsio('from base import *');
	jsio('import squill.Widget');
	jsio('import squill.Window');
	jsio('import squill.formUtil');
	jsio('import tealeaf.overlayapi as TeaLeaf');
	
	var menus = {};

	function collect(query, collection) {
		var els = $(query);
		for (var i = 0, el; el = els[i]; ++i) {
			collection[el.id] = el;
		}
	}
/*
	function initEvents() {
		$.onEvent('btnMultiplayer', 'click', bind(dialogs, 'show', 'connecting'));
		TeaLeaf.onConnect(function() {
			stack.push('lobby');
			dialogs.hide('connecting');
		});
		
		$.onEvent('btnSeek', 'click', bind(dialogs, 'show', 'seek'));
		$.onEvent('btnCancelSeek', 'click', bind(dialogs, 'hide', 'seek'));
		
		$.onEvent('btnLogin', 'click', bind(dialogs, 'show', 'login'));
		$.onEvent('btnLogout', 'click', bind(stack, 'pop'));
		$.onEvent('btnCancelConnect', 'click', bind(dialogs, 'hide', 'connecting'));
	}
*/
	function clearFocus(el) {
		el.onfocus = null;
		el.value = "";
		$.removeClass(el, 'textDefaultValue');
	}

	var DialogStack = Class(function() {
		this.init = function() {
			this._stack = [];
		}

		this.show = function(dialog) {
			var dialog = $.id(dialog);
			dialog.style.visibility = 'hidden';

			$.show(dialog);
			win.center(dialog);

			this._stack.push(dialog);
			this.stack();

			dialog.style.visibility = 'visible';
		}
		
		this.getTop = function() { return this._stack[this._stack.length - 1]; }
		
		this.stack = function() {
			for (var i = 0, len = this._stack.length; i < len - 1; ++i) {
				$(this._stack[i], {
					zIndex: 10000 + i
				});
			}
			
			if (len > 0) {
				if (!this._overlay) {
					this._overlay = $({
						parent: document.body,
						style: {
							position: 'fixed',
							top: '0px',
							left: '0px',
							width: '100%',
							height: '100%',
							opacity: 0.4,
							background: '#000'
						}
					});
				}
				
				$.style(this._overlay, {zIndex: i});
				$.style(this._stack[i], {zIndex: i + 1});
				$.show(this._overlay);
			} else {
				$.hide(this._overlay);
			}
		}

		this.hide = function(dialog) {
			if (!dialog) { dialog = this.getTop(); }
			var dialog = $.id(dialog);
			$.hide(dialog);
			for (var i = 0, el; el = this._stack[i]; ++i) {
				if (el == dialog) {
					this._stack.splice(i, 1);
					break;
				}
			}
			this.stack();
		}
	});

	var MenuStack = Class(function() {
		this.init = function() {
			this._stack = [];
			this._last = null;
		}

		this.push = function(menu) {
			this._stack.push(menu);
			this.show(menu);
		}

		this.pop = function(target) {
			var i = this._stack.length - 1;
			do {
				this._stack.pop();
			} while(i && target && target != this._stack[--i]);
			
			this.show(this._stack[i]);
		}
		
		this.show = function(menu) { 
			if (this._last) { $.hide(this._last); }
			this._last = menu;
			$.show(menu);
		}
	});
	
	var Chat = Class(squill.Widget, function() {
		this.init = function(params) {
			this._history = $.id(params.history);
			this._presence = $.id(params.presence);
			this._input = $.id(params.input);
			this._sendBtn = $.id(params.sendBtn);
			this._send = params.send;
			this.initEvents();
		}
		
		this.initEvents = function() {
			squill.formUtil.onEnter(this._input, this, 'onSendPress');
			$.onEvent(this._sendBtn, 'click', this, 'onSendPress');
		}
		
		this.onSendPress = function() {
			var msg = this._input.value;
			this._input.value = '';
			this._send(msg);
		}
		
		this.parseDate = function(date) {
			if (typeof date == 'string') {
				date = new Date(Date.parse(datetime.replace('T', ' ').replace(/\-/g, '/')));
			} else if (typeof date == 'number') {
				date = new Date(date);
			}
			return date;
		}
		
		this.i18n = {
			dayNames: [
				"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
				"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
			],
			monthNames: [
				"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
				"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
			]
		}
		
		this.formatDay = function(date) {
			return this.i18n.dayNames[date.getDay() + 7] + ', ' + this.i18n.monthNames[date.getMonth() + 12] + ' ' + (date.getDay() + 1);
		}
		
		this.formatTime = function(date) {
			var h = date.getHours(),
				m = date.getMinutes(),
				s = date.getSeconds(),
				postfix = 'am';
			
			if (m < 10) { m = '0' + m; };
			if (s < 10) { s = '0' + s; };
			if (h > 12) { postfix = 'pm'; }
			if (h == 0) { h = 12; }
			if (h > 12) { h -= 12; }
			
			return [h, m, s].join(':') + postfix;
		}
		
		this.addLine = function(when, username, msg, color, type) {
			when = this.parseDate(when);
			var msInDay = 1000 * 60 * 60 * 24;
			var day = Math.floor(when / msInDay);
			if (this._lastDay != day) {
				this._lastDay = day;
				$({
					className: 'msg_date',
					parent: this._history,
					text: this.formatDay(when)
				});
			}
			
			var line = $({
				className: 'msg_' + (type || 'user'),
				parent: this._history
			});
			
			var date = $({
				tag: 'span',
				className: 'msg_date',
				text: this.formatTime(when),
				parent: line
			});
			
			var username = $({
				tag: 'span',
				text: username + ': ',
				style: {color: color},
				parent: line
			});
			
			var msg = $({
				tag: 'span',
				text: msg,
				style: {color: color},
				parent: line
			});
		}
	});

	var stack = new MenuStack(),
		dialogs = new DialogStack(),
		win = new squill.Window(),
		isIphone = false,
		chat = new Chat({
			history: 'history',
			presence: 'presence',
			input: 'textSendMessage',
			sendBtn: 'btnSendMessage',
			send: function(msg) {
				sendEvent({
					type: 'chat',
					msg: msg
				});
			}
		});
	
//	TeaLeaf.onChat(bind(chat, 'addLine'));
//	TeaLeaf.onEnter(bind(chat, 'addUser'));
//	TeaLeaf.onLeave(bind(chat, 'removeUser'));
	
	if (isIphone) {
		$.insertCSSFile('iphone.css');
	} else {
		$.insertCSSFile('browser.css');
	}
	
	collect('.menu', menus);
	
	var dialogEls = $('.dialog');
	for (var i = 0, el; el = dialogEls[i]; ++i) {
		if (el.hasAttribute('canClose')) {
			$.onEvent($({
				className: 'dialogClose',
				before: el.firstChild,
				parent: el,
				text: 'x'
			}), 'click', bind(dialogs, 'hide', el));
		}
	}
	
	var MSG_PREFIX = 'OVERLAY:',
		MSG_PREFIX_LEN = MSG_PREFIX.length;
	
	function sendEvent(data) {
		window.parent.postMessage(MSG_PREFIX + JSON.stringify(data), '*');
	}
	
	$.onEvent(document.body, 'click', function(e) {
		var target = e.target || e.srcElement;
		while(target.parentNode) {
			if (target.tagName == 'BUTTON') {
				sendEvent({
					type: 'button',
					id: target.id
				});
				return;
			}
			target = target.parentNode;
		}
	});

	$.onEvent(window, 'message', function(e) {
		if (e.data.substring(0, MSG_PREFIX_LEN) != MSG_PREFIX) { return; }
		try {
			var data = JSON.parse(e.data.substring(8));
			switch (data.type) {
				case 'ui':
					switch(data.method) {
						case 'push':
							stack.push(data.target);
							break;
						case 'pop':
							stack.pop(data.target);
							break;
						case 'show':
							dialogs.show(data.target);
							break;
						case 'hide':
							dialogs.hide(data.target);
							break;
					}
					break;
				case 'lobbyChat':
					chat.addLine(data.date, data.username, data.msg);
					break;
			}
		} catch(e) {}
	});
	
	sendEvent({type: 'ready'});
</script>

</body>
</html>